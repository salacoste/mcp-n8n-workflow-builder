# Story 2.3: Validate & Test Tags API

<!-- Powered by BMAD™ Core -->

## Status
**✅ COMPLETED** - December 26, 2024

**Test Results:** 14/14 tests passing (100%)
**Completion Summary:** `docs/STORY-2.3-COMPLETION-SUMMARY.md`

## Story

**As a** MCP server developer and QA engineer,
**I want** comprehensive validation and testing of all 5 implemented Tags API methods against live n8n instance and documentation,
**so that** I can ensure workflow organization and tagging functionality works correctly and matches documented behavior.

## Acceptance Criteria

1. All 5 Tags API methods validated against live n8n instance (v1.82.3+)
2. Automated test suite created covering all methods with positive and negative test cases
3. Request/response formats verified against documentation for each method
4. Multi-instance routing tested and validated for all methods
5. Tag-workflow relationship handling validated
6. Tag name uniqueness and validation tested
7. Pagination validated for list endpoint
8. Error handling validated for all documented error scenarios
9. Validation report created with findings for each method
10. Integration with existing test infrastructure completed

## Tasks / Subtasks

### Task 1: Setup Tag Validation Environment (AC: 1, 2)
- [ ] Configure test environment with live n8n instance
- [ ] Create validation test file `test-tags-validation.js`
- [ ] Setup test workflow fixtures for tag assignment testing
- [ ] Create tag cleanup utilities
- [ ] Configure multi-instance test scenarios

### Task 2: Validate GET /api/v1/tags (get_tags) (AC: 1, 3, 7)
- [ ] **Test 2.1**: List all tags without pagination
  - [ ] Verify response structure matches documentation
  - [ ] Validate data types (id: string, name: string, createdAt: string, etc.)
  - [ ] Check createdAt/updatedAt are valid ISO 8601 dates
  - [ ] Verify tag metadata completeness
- [ ] **Test 2.2**: Test pagination parameters
  - [ ] Test `?limit=10` limits results correctly
  - [ ] Test `?cursor=<cursor>` retrieves next page
  - [ ] Verify nextCursor presence when more data available
  - [ ] Test pagination through complete tag list
  - [ ] Verify no duplicate tags across pages
- [ ] **Test 2.3**: Test empty tag list
  - [ ] Delete all tags in test instance
  - [ ] Verify empty array returned
  - [ ] Check response structure maintained
- [ ] **Test 2.4**: Test multi-instance routing
  - [ ] List tags from default instance
  - [ ] List tags from specific instance parameter
  - [ ] Verify instance isolation (tags unique per instance)
  - [ ] Test invalid instance handling
- [ ] **Test 2.5**: Error scenarios
  - [ ] Test with invalid API key (expect 401)
  - [ ] Test with invalid limit value (>250)
  - [ ] Test with invalid cursor format
  - [ ] Verify error response formats
- [ ] **Validation 2.6**: Compare docs vs implementation
  - [ ] Verify all documented query parameters supported
  - [ ] Check for undocumented parameters or behavior
  - [ ] Validate pagination implementation
  - [ ] Document any discrepancies found

### Task 3: Validate GET /api/v1/tags/{id} (get_tag) (AC: 1, 3)
- [ ] **Test 3.1**: Retrieve existing tag by ID
  - [ ] Verify complete tag structure returned
  - [ ] Validate all tag fields (id, name, createdAt, updatedAt)
  - [ ] Check data types match documentation
  - [ ] Verify timestamp fields format
- [ ] **Test 3.2**: Test tag with workflow associations
  - [ ] Create tag and assign to workflows
  - [ ] Retrieve tag by ID
  - [ ] Verify tag structure (workflow associations may or may not be included)
  - [ ] Document actual behavior vs documentation
- [ ] **Test 3.3**: Test multi-instance routing
  - [ ] Retrieve tag from default instance
  - [ ] Retrieve tag from specific instance
  - [ ] Verify instance isolation
  - [ ] Test cross-instance tag retrieval (expect failure)
- [ ] **Test 3.4**: Error scenarios
  - [ ] Test with non-existent tag ID (expect 404)
  - [ ] Test with invalid ID format
  - [ ] Test with invalid API key (expect 401)
  - [ ] Test with tag ID from different instance
  - [ ] Verify error response formats
- [ ] **Validation 3.5**: Compare docs vs implementation
  - [ ] Verify response structure matches documentation
  - [ ] Check for missing or extra fields
  - [ ] Document discrepancies

### Task 4: Validate POST /api/v1/tags (create_tag) (AC: 1, 3, 6)
- [ ] **Test 4.1**: Create tag with valid name
  - [ ] Create tag with simple name
  - [ ] Verify tag created successfully
  - [ ] Validate returned tag structure
  - [ ] Confirm tag appears in list
  - [ ] Verify ID generated correctly
- [ ] **Test 4.2**: Test tag name uniqueness
  - [ ] Create tag with unique name
  - [ ] Attempt to create tag with duplicate name
  - [ ] Verify duplicate handling (allowed or error?)
  - [ ] Document actual behavior
- [ ] **Test 4.3**: Test tag name validation
  - [ ] Test with empty name (expect 400 or validation error)
  - [ ] Test with very long name (>255 characters)
  - [ ] Test with special characters (@, #, $, %, etc.)
  - [ ] Test with Unicode characters (emoji, non-Latin)
  - [ ] Test with whitespace (leading, trailing, multiple spaces)
  - [ ] Document validation rules
- [ ] **Test 4.4**: Test multi-instance creation
  - [ ] Create tag in default instance
  - [ ] Create tag in specific instance
  - [ ] Verify instance isolation (same name allowed in different instances)
- [ ] **Test 4.5**: Error scenarios
  - [ ] Test with missing required fields (expect 400)
  - [ ] Test with invalid request body structure
  - [ ] Test with extra undocumented fields
  - [ ] Verify error messages are descriptive
- [ ] **Validation 4.6**: Compare docs vs implementation
  - [ ] Verify all documented request body fields supported
  - [ ] Check request body validation rules
  - [ ] Document name validation behavior
  - [ ] Note discrepancies

### Task 5: Validate PUT /api/v1/tags/{id} (update_tag) (AC: 1, 3, 6)
- [ ] **Test 5.1**: Update tag name successfully
  - [ ] Create tag
  - [ ] Update tag name to new value
  - [ ] Verify name updated correctly
  - [ ] Check updatedAt field changed
  - [ ] Verify tag retrieval returns new name
- [ ] **Test 5.2**: Test tag name uniqueness on update
  - [ ] Create two tags (Tag A, Tag B)
  - [ ] Attempt to update Tag A name to Tag B name
  - [ ] Verify duplicate handling behavior
  - [ ] Document actual behavior (allowed or error?)
- [ ] **Test 5.3**: Test update validation
  - [ ] Update to empty name (expect error)
  - [ ] Update to very long name
  - [ ] Update with special characters
  - [ ] Verify validation same as create
- [ ] **Test 5.4**: Test update idempotency
  - [ ] Update tag name
  - [ ] Update again with same name
  - [ ] Verify no error occurs
  - [ ] Check updatedAt behavior
- [ ] **Test 5.5**: Test multi-instance update
  - [ ] Update tag in default instance
  - [ ] Update tag in specific instance
  - [ ] Verify instance isolation
  - [ ] Test cross-instance update (expect failure)
- [ ] **Test 5.6**: Error scenarios
  - [ ] Test updating non-existent tag (expect 404)
  - [ ] Test with invalid tag ID
  - [ ] Test with malformed request body
  - [ ] Verify error handling
- [ ] **Validation 5.7**: Compare docs vs implementation
  - [ ] Verify PUT behavior (full replacement vs partial update)
  - [ ] Document update semantics
  - [ ] Note discrepancies

### Task 6: Validate DELETE /api/v1/tags/{id} (delete_tag) (AC: 1, 3, 5)
- [ ] **Test 6.1**: Delete tag successfully
  - [ ] Create tag
  - [ ] Delete tag
  - [ ] Verify tag removed from list
  - [ ] Confirm deletion response format
  - [ ] Verify tag cannot be retrieved after deletion
- [ ] **Test 6.2**: Delete tag with workflow associations
  - [ ] Create tag and assign to workflows
  - [ ] Delete tag
  - [ ] Verify tag removed
  - [ ] Check workflows still exist
  - [ ] Verify tag removed from workflow tag lists
  - [ ] Document cascade behavior
- [ ] **Test 6.3**: Test deletion permanence
  - [ ] Delete tag
  - [ ] Verify tag truly removed
  - [ ] Check tag doesn't reappear in lists
  - [ ] Test that deletion is permanent
- [ ] **Test 6.4**: Test multi-instance deletion
  - [ ] Delete from default instance
  - [ ] Delete from specific instance
  - [ ] Verify instance isolation
  - [ ] Test cross-instance deletion (expect failure)
- [ ] **Test 6.5**: Error scenarios
  - [ ] Test deleting non-existent tag (expect 404)
  - [ ] Test deleting already deleted tag
  - [ ] Test with invalid ID format
  - [ ] Test with invalid API key (expect 401)
  - [ ] Verify error responses
- [ ] **Validation 6.6**: Compare docs vs implementation
  - [ ] Verify deletion is permanent
  - [ ] Check cascade behavior with workflows
  - [ ] Validate deletion response format
  - [ ] Document deletion semantics

### Task 7: Test Tag-Workflow Relationships (AC: 5)
- [ ] **Test 7.1**: Assign tag to workflow
  - [ ] Create tag
  - [ ] Create workflow with tag ID in tags array
  - [ ] Verify workflow created with tag
  - [ ] Retrieve workflow and verify tag association
- [ ] **Test 7.2**: Assign multiple tags to workflow
  - [ ] Create multiple tags
  - [ ] Create workflow with multiple tag IDs
  - [ ] Verify all tags assigned correctly
  - [ ] Test tag order preservation
- [ ] **Test 7.3**: Update workflow tags
  - [ ] Create workflow with initial tags
  - [ ] Update workflow with different tags
  - [ ] Verify tag list updated
  - [ ] Check old tags removed, new tags added
- [ ] **Test 7.4**: Filter workflows by tag
  - [ ] Create workflows with various tags
  - [ ] Use GET /workflows?tags=<tagId> to filter
  - [ ] Verify filtering works correctly
  - [ ] Test with multiple tag IDs
- [ ] **Test 7.5**: Test orphaned tags
  - [ ] Create tag
  - [ ] Assign to workflow
  - [ ] Delete workflow
  - [ ] Verify tag still exists (orphaned)
  - [ ] Document tag lifecycle behavior
- [ ] **Test 7.6**: Test tag deletion impact on workflows
  - [ ] Create workflow with tag
  - [ ] Delete tag
  - [ ] Retrieve workflow
  - [ ] Verify tag removed from workflow tags array
  - [ ] Document cascade behavior

### Task 8: Multi-Instance Validation (AC: 4)
- [ ] Test all 5 methods with production instance parameter
- [ ] Test all 5 methods with staging instance parameter
- [ ] Test all 5 methods with default instance (no parameter)
- [ ] Verify instance routing works correctly for all methods
- [ ] Test invalid instance parameter handling
- [ ] Verify tag isolation between instances
- [ ] Document multi-instance behavior

### Task 9: Error Handling Validation (AC: 8)
- [ ] Verify 401 Unauthorized for invalid API key (all methods)
- [ ] Verify 404 Not Found for non-existent tags (get, update, delete)
- [ ] Verify 400 Bad Request for malformed requests (create, update)
- [ ] Verify validation errors for invalid tag names
- [ ] Test error response format consistency
- [ ] Document error handling patterns

### Task 10: Create Validation Report (AC: 9)
- [ ] Document findings for each method
- [ ] List discrepancies between docs and implementation
- [ ] Document tag name validation rules
- [ ] Document tag-workflow relationship behavior
- [ ] Rate implementation quality (1-5) for each method
- [ ] Create prioritized list of issues to address
- [ ] Generate validation summary with statistics

### Task 11: Integration with Test Infrastructure (AC: 10)
- [ ] Integrate validation tests into `test-mcp-tools.js`
- [ ] Add tags validation section to test suite
- [ ] Ensure tests can run independently
- [ ] Add tag cleanup after test execution
- [ ] Document how to run validation tests
- [ ] Create helper utilities for tag management

## Dev Notes

### Relevant Source Tree

**Implementation Files:**
- `src/index.ts` - MCP tool registration for tag methods (lines 561-644)
- `src/services/n8nApiWrapper.ts` - Tag API method implementations
- `src/services/environmentManager.ts` - Multi-instance routing logic

**Test Files:**
- `test-mcp-tools.js` - Existing comprehensive test suite (includes tag tests)
- `test-comprehensive.js` - Integration test reference

**Documentation Files:**
- `docs/n8n-api-docs/40-TAGS-API.md` - Complete Tags API documentation (5 methods)
- `docs/n8n-api-docs/00-INDEX.md` - API navigation

### Current Implementation Analysis

**Implemented Methods (5/5 - 100% Coverage):**

1. **create_tag** (src/index.ts:561)
   - Maps to: POST /tags
   - Supports: Tag creation with name validation
   - Multi-instance: ✅ Supported

2. **get_tags** (src/index.ts:580)
   - Maps to: GET /tags
   - Supports: List all tags with pagination
   - Multi-instance: ✅ Supported
   - Note: Also available as get_tag (plural alias)

3. **get_tag** (src/index.ts:602)
   - Maps to: GET /tags/{id}
   - Returns: Single tag by ID
   - Multi-instance: ✅ Supported

4. **update_tag** (src/index.ts:621)
   - Maps to: PUT /tags/{id}
   - Supports: Tag name updates
   - Multi-instance: ✅ Supported

5. **delete_tag** (src/index.ts:644)
   - Maps to: DELETE /tags/{id}
   - Multi-instance: ✅ Supported

**Implementation Status:**
✅ **100% Complete** - All documented Tags API methods are implemented

### Key Implementation Points

**Tag Structure:**
```typescript
interface Tag {
  id: string;           // Unique tag identifier
  name: string;         // Tag name
  createdAt: string;    // ISO 8601 creation date
  updatedAt: string;    // ISO 8601 last update date
}
```

**Workflow-Tag Relationship:**
- Tags assigned to workflows via `tags` array field in workflow object
- Tags array contains tag IDs (strings), not full tag objects
- Multiple tags can be assigned to a single workflow
- Tags can exist without workflow assignments (orphaned tags)

**Tag Name Validation:**
- Needs testing to determine exact rules
- Likely constraints: non-empty, length limits, character restrictions
- Uniqueness behavior needs validation (per-instance or global?)

**Pagination:**
- Uses cursor-based pagination (same as Executions API)
- `cursor` parameter obtained from `nextCursor` in previous response
- `limit` parameter (default: 100, max: 250)

**Multi-Instance Pattern:**
All methods follow this pattern:
```typescript
{
  instance: {
    type: 'string',
    description: 'Instance identifier (optional, uses default if not provided)'
  }
}
```

**Error Handling:**
- Uses `callWithInstance` pattern from N8NApiWrapper
- Provides detailed error messages with instance context
- Logs errors to stderr via console.error()

### Known Issues & Limitations

1. **Tag Update 409 Conflicts:**
   - Historical issue with tag name updates returning 409 Conflict
   - Test suite uses UUID generation for unique tag names as workaround
   - Needs validation to check if still occurs
   - See: test-mcp-tools.js workaround

2. **Tag Name Uniqueness:**
   - Unclear if tag names must be unique per instance or globally
   - Needs validation testing
   - May vary by n8n version

3. **Cascade Behavior:**
   - Tag deletion impact on workflows needs validation
   - Are tags removed from workflow.tags array automatically?
   - Or do workflows retain IDs of deleted tags?

4. **Workflow Assignment:**
   - Tags assigned during workflow create/update operations
   - No dedicated "assign tag to workflow" endpoint
   - Workflow must be updated to change tags

### Testing Standards

**Test Framework:**
- Node.js with axios for HTTP requests
- JSON-RPC 2.0 protocol for MCP communication
- Test environment: `http://localhost:3456/mcp`

**Test File Location:**
- Create: `test-tags-validation.js`
- Integrate with: `test-mcp-tools.js`

**Test Patterns:**
```javascript
const config = {
  mcpServerUrl: 'http://localhost:3456/mcp',
  testTagName: `Validation-Test-Tag-${Date.now()}`, // Unique names
  testFlags: {
    runTagTests: true,
    testTagWorkflowRelationships: true,
    runCleanup: true
  }
};
```

**Coverage Requirements:**
- ✅ Positive test cases (happy path)
- ✅ Negative test cases (error scenarios)
- ✅ Edge cases (name validation, uniqueness, etc.)
- ✅ Multi-instance scenarios
- ✅ Tag-workflow relationship testing
- ✅ Error handling validation
- ✅ Documentation accuracy verification

**Cleanup Strategy:**
- Delete all test tags after validation
- Use tag name prefix with timestamp for easy identification
- Configurable cleanup via `runCleanup` flag
- Clean up test workflows associated with tags

### Validation Checklist Template

For each method, validate:

- [ ] ✅ **Request Format**: Matches documentation
- [ ] ✅ **Response Format**: Matches documentation
- [ ] ✅ **Data Types**: All fields have correct types
- [ ] ✅ **Required Fields**: All required fields present
- [ ] ✅ **Optional Fields**: Optional fields work correctly
- [ ] ✅ **Validation Rules**: Name validation rules documented
- [ ] ✅ **Pagination**: Cursor-based pagination works correctly
- [ ] ✅ **Multi-Instance**: Instance routing works
- [ ] ✅ **Error Handling**: All documented errors tested
- [ ] ✅ **Relationships**: Tag-workflow associations work
- [ ] ⚠️ **Discrepancies**: Document any differences found

### Test Workflow for Tag Relationships

**Create Test Workflow with Tags:**
```json
{
  "name": "Tag Relationship Test Workflow",
  "tags": ["tag-id-1", "tag-id-2"],
  "nodes": [
    {
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "position": [250, 300]
    }
  ],
  "connections": {}
}
```

### Documentation References

**Primary Documentation:**
- `docs/n8n-api-docs/40-TAGS-API.md` - Complete method documentation
- Lines 32-150: GET /tags (list)
- Lines 200-300: GET /tags/{id} (get)
- Lines 300-400: POST /tags (create)
- Lines 400-500: PUT /tags/{id} (update)
- Lines 500-600: DELETE /tags/{id} (delete)
- Lines 600+: Tag structure and examples

**Implementation References:**
- `test-mcp-tools.js` - Existing tag tests with UUID workaround
- `CLAUDE.md` - Known limitations and constraints
- `README.md` - API usage examples

### Known Test Suite Issues

**From test-mcp-tools.js:**
```javascript
// Tag Update 409 Conflict Workaround
// Use UUID to ensure unique tag names
const testTag = {
  name: `MCP-Test-Tag-${uuidv4()}`
};
```

**Issue Context:**
- Tag name updates historically returned 409 Conflict errors
- Workaround: Use UUID generation for unique names
- Needs validation: Is this still an issue in n8n v1.82.3?

## Testing

### Test Approach

**Phase 1: Individual Method Validation**
- Test each method in isolation
- Validate request/response formats
- Document all findings

**Phase 2: Tag Name Validation Testing**
- Test all validation rules
- Test uniqueness behavior
- Document validation constraints

**Phase 3: Tag-Workflow Relationship Testing**
- Test tag assignment during workflow creation
- Test tag updates on workflows
- Test workflow filtering by tags
- Test cascade behavior on tag deletion

**Phase 4: Multi-Instance Testing**
- Test all methods across different instances
- Verify instance isolation
- Test tag name uniqueness per instance

**Phase 5: Pagination Testing**
- Test cursor-based pagination
- Test with large tag lists
- Verify no duplicates across pages

**Phase 6: Documentation Validation**
- Compare implementation vs documentation
- Identify discrepancies
- Update validation report

### Edge Cases to Test

1. **Empty Tag List**: Test when no tags exist
2. **Large Tag List**: Test pagination with 500+ tags
3. **Long Tag Names**: Test maximum name length
4. **Special Characters**: Test Unicode, emoji, special chars in names
5. **Whitespace Handling**: Leading/trailing/multiple spaces
6. **Duplicate Names**: Test uniqueness enforcement
7. **Orphaned Tags**: Tags with no workflow associations
8. **Concurrent Operations**: Simultaneous tag create/update/delete
9. **Workflow with Many Tags**: Test with 50+ tags on single workflow
10. **Cross-Instance Tag Names**: Same tag name in different instances

### Testing Frameworks & Patterns

**Test Execution:**
```bash
# Run validation tests
npm run build
npm start &  # Start MCP server
node test-tags-validation.js
```

**Test Structure:**
```javascript
describe('Tags API Validation', () => {
  describe('GET /tags (get_tags)', () => {
    test('should list all tags', async () => {
      // Test implementation
    });

    test('should paginate correctly', async () => {
      // Test implementation
    });

    // ... more tests
  });

  // ... more method test suites
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-26 | 1.0 | Story created for Tags API validation | Sarah (PO) |

## Dev Agent Record

*This section will be populated by the development agent during implementation.*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results

*This section will be populated by QA agent after validation completion.*
